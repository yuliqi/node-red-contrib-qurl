<script type="text/javascript">
RED.nodes.registerType("qurl", {
    category: "network-input",
    defaults: {
        name: { value: "" },
        endpoint: { type: "qurl-config", required: true },
        method: { value: "get", required: true },
        url: { value: "" },
        responseType: { value: "json" },
        keepAlive: { value: false },
        timeout: { value: 30000, required: true },
        validateStatus: { value: true },
        verboseOut: { value: false },
        useQurl: { value: false },
        headers: { value: [] },
        params: { value: [] }
    },
    inputs: 1,
    outputs: 1,
    color: "#E2D96E",
    icon: "icons/node-red/white-globe.svg",
    paletteLabel: "qurl",
    oneditprepare: function() {
        const node = this;
        ['params', 'headers'].forEach(property => {
            const plist = node[property] || [];
            const list = $(`#node-input-${property}-container`)
            .editableList({
                addItem: function (container, i, prop) {
                    const row = $('<div/>').css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap',
                        display: 'flex'
                    }).appendTo(container);

                    const propertyKeyCell = $('<div/>').css({ 'flex-grow': 1 }).appendTo(row);
                    const propertyKeyValue = $('<input/>', {
                        class: `node-input-${property}-name`,
                        type: "text",
                        style: "width: 100%",
                        placeholder: "é”®"
                        })
                        .appendTo(propertyKeyCell)
                        .typedInput({ types: ["str", "msg", "flow", "global"] });
                    propertyKeyValue.typedInput('type', prop.keyType || 'str');
                    propertyKeyValue.typedInput('value', prop.keyValue || '');

                    const propertyValueCell = $('<div/>').css({ 'flex-grow': 1, 'margin-left': '10px' }).appendTo(row);
                    const propertyValue = $('<input/>', {
                        class: `node-input-${property}-value`,
                        type: "text",
                        style: "width: 100%",
                        placeholder: "å€¼"
                        })
                        .appendTo(propertyValueCell)
                        .typedInput({ types: ["str", "msg", "flow", "global"] });
                    propertyValue.typedInput('type', prop.valueType || 'str');
                    propertyValue.typedInput('value', prop.valueValue || '');
                },
                sortable: true,
                removable: true
            });
            plist.forEach(prop => {
                list.editableList('addItem', prop);
            });
        });
    },
    oneditsave: function() {
        ['params', 'headers'].forEach(property => {
            const list = $(`#node-input-${property}-container`).editableList('items');
            const node = this;
            node[property] = [];
            list.each(function(i) {
                const prop = $(this);
                const keyType = prop.find(`.node-input-${property}-name`).typedInput('type');
                const keyValue = prop.find(`.node-input-${property}-name`).typedInput('value');
                const valueType = prop.find(`.node-input-${property}-value`).typedInput('type');
                const valueValue = prop.find(`.node-input-${property}-value`).typedInput('value');
                node[property].push({ keyType, keyValue, valueType, valueValue });
            });
        });
    },
    oneditresize: function(size) {
        const dlg = $("#dialog-form");
        ['params', 'headers'].forEach(property => {
            const expandRow = dlg.find(`.node-input-${property}-container-row`);
            let height = dlg.height() - 5;
            if(expandRow && expandRow.length){
                const siblingRows = dlg.find(`> .form-row:not(.node-input-${property}-container-row)`);
                for (let i = 0; i < siblingRows.size(); i++) {
                    const cr = $(siblingRows[i]);
                    if(cr.is(":visible"))
                        height -= cr.outerHeight(true);
                }
                $(`#node-input-${property}-container`).editableList('height',height);
            }
        });
    },
    label: function () {
        return `[${this.method.toUpperCase()}] ${this.name || this.url || "è¯·æ±‚"}`;
    },
});
</script>

<script type="text/html" data-template-name="qurl">
<div class="form-row">
    <label for="node-input-endpoint"><i class="fa fa-server"></i> æ¥å£é…ç½®</label>
    <input type="text" id="node-input-endpoint" />
</div>
<div class="form-row">
    <label for="node-input-method"><i class="fa fa-envelope-o"></i> è¯·æ±‚æ–¹æ³•</label>
    <select id="node-input-method">
        <option value="get">GET</option>
        <option value="post">POST</option>
        <option value="put">PUT</option>
        <option value="delete">DELETE</option>
        <option value="patch">PATCH</option>
        <option value="HEAD">HEAD</option>
        <option value="use">- ç”¨ msg.method è®¾å®š -</option>
    </select>
</div>
<div class="form-row">
    <label for="node-input-url"><i class="fa fa-terminal"></i> URL</label>
    <input type="text" id="node-input-url" placeholder="/èµ„æºè·¯å¾„" />
</div>
<div class="form-row" style="margin-bottom:0;">
    <label><i class="fa fa-list"></i> URL å‚æ•°</label>
</div>
<div class="form-row node-input-params-container-row">
    <ol id="node-input-params-container"></ol>
</div>
<div class="form-row" style="margin-bottom:0;">
    <label><i class="fa fa-list"></i> å¤´</label>
</div>
<div class="form-row node-input-headers-container-row">
    <ol id="node-input-headers-container"></ol>
</div>
<div class="form-row">
    <label for="node-input-responseType"><i class="fa fa-sign-out"></i> è¿”å›</label>
    <select id="node-input-responseType">
        <option value="json">JSON</option>
        <option value="text">æ–‡æœ¬</option>
        <option value="arraybuffer">Array Buffer</option>
    </select>
</div>
<div class="form-row">
    <input type="checkbox" id="node-input-keepAlive" style="display: inline-block; width: auto; vertical-align: top;" />
    <label for="node-input-keepAlive" style="width: auto;">å¯¹è¿æ¥å¯ç”¨keep-alive</label>
</div>
<div class="form-row">
    <label for="node-input-timeout"><i class="fa fa-clock-o"></i> è¶…æ—¶æ—¶é—´</label>
    <input type="number" id="node-input-timeout" />
    <span>æ¯«ç§’</span>
</div>
<div class="form-row">
    <input type="checkbox" id="node-input-validateStatus" style="display: inline-block; width: auto; vertical-align: top;" />
    <label for="node-input-validateStatus" style="width: auto;">ä»…å‘ Catch èŠ‚ç‚¹å‘é€é 2xx å“åº”</label>
</div>
<div class="form-row">
    <input type="checkbox" id="node-input-verboseOut" style="display: inline-block; width: auto; vertical-align: top;" />
    <label for="node-input-verboseOut" style="width: auto;">è¯¦ç»†è¾“å‡º</label>
</div>
<div class="form-row">
    <input type="checkbox" id="node-input-useQurl" style="display: inline-block; width: auto; vertical-align: top;" />
    <label for="node-input-useQurl" style="width: auto;">é€šè¿‡ msg.qurl æ‰§è¡Œï¼ˆå¯ç”¨åèŠ‚ç‚¹ä»…æ³¨å…¥å¼‚æ­¥è¯·æ±‚å‡½æ•°ï¼‰</label>
</div>
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> èŠ‚ç‚¹åç§°</label>
    <input type="text" id="node-input-name" />
</div>
</script>

<script type="text/markdown" data-help-name="qurl">
### æ¦‚è¿°

**qurl èŠ‚ç‚¹** ç”¨äºå‘èµ· HTTP/HTTPS è¯·æ±‚ï¼Œæ”¯æŒé…ç½®è¯·æ±‚æ–¹æ³•ã€è·¯å¾„ã€è¶…æ—¶ã€è®¤è¯ã€ä»£ç†ã€ä»¥åŠå“åº”å¤„ç†æ–¹å¼ã€‚  
å¯åœ¨ä¸¤ç§æ¨¡å¼ä¸‹è¿è¡Œï¼š

1. **ç›´æ¥è¯·æ±‚æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰**ï¼šèŠ‚ç‚¹åœ¨æ‰§è¡Œæ—¶ç«‹å³å‘èµ·ç½‘ç»œè¯·æ±‚ã€‚  
2. **msg.qurl æ¨¡å¼**ï¼šä»…æ³¨å…¥å¼‚æ­¥è¯·æ±‚å‡½æ•°ï¼Œä¸ä¸»åŠ¨å‘èµ·è¯·æ±‚ï¼Œç”± Function èŠ‚ç‚¹è‡ªç”±è°ƒç”¨ã€‚

---

### èŠ‚ç‚¹å±æ€§

| å±æ€§ | è¯´æ˜ |
|------|------|
| **åç§° (name)** | èŠ‚ç‚¹åç§°ï¼Œéå¿…å¡«ã€‚ |
| **ç«¯ç‚¹é…ç½® (endpoint)** | å¼•ç”¨ `qurl-config` é…ç½®èŠ‚ç‚¹ï¼ŒåŒ…å«åŸºç¡€ URLã€ä»£ç†ã€è¯ä¹¦ç­‰ã€‚ |
| **è¯·æ±‚æ–¹æ³• (method)** | GET / POST / PUT / DELETE / PATCH ç­‰ã€‚ |
| **è¯·æ±‚è·¯å¾„ (url)** | è¯·æ±‚è·¯å¾„ï¼Œå¯ä¸ºç›¸å¯¹æˆ–ç»å¯¹è·¯å¾„ã€‚ |
| **å“åº”ç±»å‹ (responseType)** | æ”¯æŒ `json`ã€`text`ã€`arraybuffer`ã€`stream`ã€‚ |
| **ä¿æŒè¿æ¥ (keepAlive)** | å¯ç”¨å HTTP è¿æ¥å¤ç”¨ï¼Œå‡å°‘æ¡æ‰‹å¼€é”€ã€‚ |
| **è¶…æ—¶ (timeout)** | è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚ |
| **è¯·æ±‚å¤´ (headers)** | è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼ˆJSON æ ¼å¼æˆ– msg.headersï¼‰ã€‚ |
| **è¯¦ç»†è¾“å‡º (fullResponse)** | å¯ç”¨åè¾“å‡ºå®Œæ•´å“åº”ï¼ˆåŒ…å« statusã€headersã€dataï¼‰ã€‚ |
| **é€šè¿‡ msg.qurl æ‰§è¡Œ (useQurl)** | å¯ç”¨åèŠ‚ç‚¹ä¸ç›´æ¥è¯·æ±‚ï¼Œè€Œæ˜¯æ³¨å…¥å¼‚æ­¥å‡½æ•° `msg.qurl()` ä¾›åç»­èŠ‚ç‚¹è°ƒç”¨ã€‚ |

---

### æ¶ˆæ¯å±æ€§

| å±æ€§ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `msg.payload` | ä»»æ„ | è¯·æ±‚ä½“æ•°æ®ï¼Œä»…é€‚ç”¨äº POST/PUT/PATCH/DELETEã€‚ |
| `msg.params` | Object | URL æŸ¥è¯¢å‚æ•°ã€‚ |
| `msg.headers` | Object | é¢å¤–è¯·æ±‚å¤´ï¼Œä¼šä¸èŠ‚ç‚¹é…ç½®åˆå¹¶ã€‚ |
| `msg.url` | String | è‹¥è®¾ç½®ï¼Œåˆ™è¦†ç›–èŠ‚ç‚¹é…ç½®ä¸­çš„ URLã€‚ |
| `msg.method` | String | è‹¥è®¾ç½®ï¼Œåˆ™è¦†ç›–èŠ‚ç‚¹é…ç½®ä¸­çš„è¯·æ±‚æ–¹æ³•ã€‚ |
| `msg.responseType` | String | è‹¥è®¾ç½®ï¼Œåˆ™è¦†ç›–èŠ‚ç‚¹é…ç½®ã€‚ |

---

### è¾“å‡ºæ¶ˆæ¯

**æˆåŠŸè¾“å‡º (ç¬¬1è¾“å‡ºç«¯)**ï¼š
```js
msg = {
    status: 200,
    headers: { ... },
    payload: {...}  // è‹¥ fullResponse=falseï¼Œåˆ™ä»…è¾“å‡º data
}
````

**é”™è¯¯è¾“å‡º (ç¬¬2è¾“å‡ºç«¯)**ï¼š

```js
msg = {
    error: err,     // AxiosError å¯¹è±¡
    status: err.response?.status,
    payload: err.response?.data
}
```

---

### é€šè¿‡ msg.qurl æ‰§è¡Œæ¨¡å¼ï¼ˆå¯ç”¨ â€œé€šè¿‡ msg.qurl æ‰§è¡Œâ€ï¼‰

å½“å‹¾é€‰è¯¥é€‰é¡¹åï¼ŒèŠ‚ç‚¹ **ä¸ä¼šç«‹å³å‘èµ·è¯·æ±‚**ï¼Œ
è€Œæ˜¯å°†ä¸€ä¸ªå¼‚æ­¥æ–¹æ³• `msg.qurl` æ³¨å…¥åˆ°æ¶ˆæ¯å¯¹è±¡ä¸­ã€‚

ä½ å¯ä»¥åœ¨ Function èŠ‚ç‚¹ä¸­ä½¿ç”¨ `await qurl({...})` è°ƒç”¨å®ƒæ¥çµæ´»åœ°æ‰§è¡Œè¯·æ±‚ã€‚
è¯¥æ–¹æ³•çš„å‚æ•°ä¸ [Axios è¯·æ±‚é…ç½®](https://axios-http.com/docs/req_config) å®Œå…¨å…¼å®¹ã€‚

#### ç¤ºä¾‹ï¼š

```js
const { qurl } = msg;

try {
    const res = await qurl({
        method: "post",
        url: "/users",
        data: { name: "Alice" },
        params: { debug: true },
        headers: { "X-Auth": "token" }
    });

    msg.payload = res.data;
    return [msg, null]; // æ­£å¸¸è¾“å‡º
} catch (err) {
    msg.error = err;
    return [null, msg]; // é”™è¯¯è¾“å‡º
}
```

> ğŸ’¡ è¯¥æ¨¡å¼å¸¸ç”¨äºäº‹åŠ¡æ§åˆ¶ã€å¼‚æ­¥æµç¨‹ã€æ•°æ®åº“æ“ä½œåå†è°ƒç”¨ API çš„åœºæ™¯ã€‚
> å½“ Function èŠ‚ç‚¹ä¸­æœªè°ƒç”¨ `qurl()` æ—¶ï¼Œè¯·æ±‚ä¸ä¼šæ‰§è¡Œã€‚

---

### èŠ‚ç‚¹çŠ¶æ€

| çŠ¶æ€         | è¯´æ˜                       |
| ---------- | ------------------------ |
| ğŸŸ¢ ready   | èŠ‚ç‚¹å·²åˆå§‹åŒ–ã€‚                  |
| ğŸŸ¡ sending | æ­£åœ¨å‘é€è¯·æ±‚ã€‚                  |
| ğŸŸ  waiting | ç­‰å¾…å¼‚æ­¥è°ƒç”¨ï¼ˆå¯ç”¨ msg.qurl æ¨¡å¼æ—¶ï¼‰ã€‚ |
| ğŸ”´ error   | è¯·æ±‚å¤±è´¥æˆ–é…ç½®é”™è¯¯ã€‚               |

---

### æ³¨æ„äº‹é¡¹

* è‹¥é…ç½®èŠ‚ç‚¹ä¸­è®¾ç½®äº†è®¤è¯ä¿¡æ¯ï¼ˆBasic/Auth/Tokenï¼‰ï¼Œå°†è‡ªåŠ¨é™„åŠ åˆ°è¯·æ±‚å¤´ã€‚
* `timeout` å»ºè®®è®¾ç½®åœ¨ 30 ç§’ä»¥å†…ï¼Œä»¥é¿å…æµç¨‹é˜»å¡ã€‚
* å“åº”ç±»å‹ä¸º `stream` æ—¶ï¼Œè¿”å› `Readable` å¯¹è±¡ï¼Œå¯ç”¨äºæ–‡ä»¶å†™å…¥æˆ–è½¬å‘ã€‚
* `msg.qurl` æ”¯æŒå¹¶å‘è°ƒç”¨ï¼Œäº’ä¸å¹²æ‰°ã€‚
* å»ºè®®æ­é… Functionã€Switchã€Catchã€Status èŠ‚ç‚¹ç»„åˆä½¿ç”¨ä»¥å®ç°å®Œæ•´æ§åˆ¶æµã€‚

</script>
